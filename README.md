# 都市交通シミュレーション

ブラウザ上で動作する2D都市交通シミュレーションゲーム。  
リロードのたびに異なる道路レイアウト・地形・川が自動生成される。  
信号制御・予算管理・事故対応・パトカー派遣などを通じて渋滞を解消し、スコアを伸ばす。

---

## 起動方法

```
traffic_simulation_fixed.html をブラウザで開く
```

以下のファイルを同じディレクトリに配置する。画像が存在しない場合はフォールバック表示で動作する。

| ファイル名 | 内容 | サイズ |
|---|---|---|
| `douro.png` | 幹線・支線道路テクスチャ | 横タイル任意 |
| `douro_small.png` | 一方通行道路テクスチャ | 67×67 px |
| `river.png` | 川テクスチャ | 128×128 px |
| `parking.png` | 駐車場画像 | 60×60 px |
| `shingou_blue.png` | 信号機（青） | 400×150 px |
| `shingou_red.png` | 信号機（赤） | 400×150 px |
| `car_police.png` | パトカー画像 | 任意（20×12 px相当で表示） |
| `car1.png` 〜 `car10.png` | 車両画像（10種） | 20×12 px相当 |
| `house1.png` 〜 `house8.png` | 住宅画像（8種） | 40×40 px相当 |
| `company1.png` 〜 `company4.png` | 会社ビル画像（4種） | 50×50 px |
| `park1.png` | 公園画像 | 40×40 px相当 |
| `ground_1.png` | 地形タイル（草地） | 128×128 px |
| `ground_2.png` | 地形タイル（砂地） | 128×128 px |
| `ground_3.png` | 地形タイル（土） | 128×128 px |

---

## ゲームの目的

交差点への信号設置・一方通行の反転・事故対応などを通じて渋滞を解消し、スコアを稼ぐ。  
スコアは同時に「予算」として機能し、各種操作のコストに充てる。

---

## UI操作

### スコアバー（画面最上部）

| 表示 | 説明 |
|---|---|
| **SCORE / 予算** | 現在の累計スコア（＝使用可能予算） |
| **RANK** | S / A / B / C / D のランク |
| **BONUS** | 渋滞ゼロ継続で上昇するボーナス倍率（最大×8.0） |
| **事故件数** | 累計発生事故数 |

### コントロールパネル（上部）

| 操作 | 説明 |
|---|---|
| **流入量スライダー** | 車の発生頻度（0〜100） |
| **交差点青時間スライダー** | 選択中交差点の信号青時間（60〜300フレーム） |

### サイドパネル（右側）— 予算操作

| ボタン | コスト | 操作方法 |
|---|---|---|
| **信号設置** | -500pt | モード選択後、交差点をクリック |
| **信号撤去** | -300pt | モード選択後、交差点をクリック |
| **一方通行反転** | -800pt | モード選択後、道路を1回クリック（黄色ハイライト）→ もう1回で確定 |
| **事故対応** | -300pt | ボタンクリック、または Canvas上の💥を直接クリック |
| **✕ キャンセル** | 無料 | モードを通常に戻す |

---

## スコアシステム

### 加算

- 車が目的地に到着: **+200点 × ボーナス倍率**
- 渋滞ゼロが60フレーム（約1秒）続くごとにボーナス倍率 **+0.2**（上限×8.0）

### ペナルティ

| イベント | ペナルティ |
|---|---|
| 渋滞中（1台/フレーム） | -0.2点 |
| 事故発生時 | -500点 |
| 事故継続中（1件/フレーム） | -1点 |
| 信号設置 | -500点 |
| 信号撤去 | -300点 |
| 一方通行反転 | -800点 |
| 事故対応（緊急解消） | -300点 |

### ランク基準

| ランク | 必要スコア |
|---|---|
| S | 80,000点以上 |
| A | 35,000点以上 |
| B | 12,000点以上 |
| C | 3,000点以上 |
| D | 3,000点未満 |

---

## 信号なし交差点

初期状態では内部交差点の約40%のみ信号が設置されている。  
信号のない交差点では以下の挙動になる。

| 状態 | 挙動 |
|---|---|
| 交差点まで残り35%の地点から | 最大速度の15%に徐行制限 |
| 同じ交差点へ向かう他の車がいる | 先に来ている車（pos大）に完全停止して譲る |
| 表示 | 交差点に⚠マーク |

信号を設置すれば通常の2フェーズ制御（縦/横）が機能し、スムーズに流れるようになる。

---

## 事故イベント

60〜120秒に1回、ランダムに交通事故が発生する。

**発生時の挙動**

- 走行中の車がいるエッジ上のランダムな地点で発生
- 💥アイコンと赤い影響圏（半径80px）を表示
- 影響圏内の車は強制徐行（速度0.2以下）→ 渋滞が伝播
- 残り時間バーが表示され、終盤ほど点滅が速くなる
- 約30秒後（1800フレーム）に自動復旧

**パトカー派遣**

- 事故発生と同時に外部ノードからパトカーをBFSで最寄り交差点へ自動派遣
- 走行中はサイレン（赤/青交互点滅）が光る
- 現場到着後は事故が解消されるまで待機（💥横に🚔表示）
- 事故解消とともに消滅

**手動対応**

- 🚨ボタンまたは💥アイコンをクリックで即時解消（-300点）

---

## 道路生成ロジック

リロードのたびにランダムな都市道路が生成される。4レイヤーの階層モデル。

### レイヤー1: 幹線（main）

- 水平線 2〜3本 + 垂直線 2〜3本をランダムなy/x座標に配置
- 交点を自動計算して交差点ノードを生成
- 2車線（片側2レーン）、双方向エッジペア

**外部ノード生成パターン（リロードごとにランダム選択）**

| パターン | 確率 | 内容 |
|---|---|---|
| A | 40% | 全幹線端に外部ノード |
| B | 35% | 各端を約55%の確率で間引き |
| C | 25% | 各端を約25%のみ生成（内側都市型） |

### レイヤー2: 支線（branch）

- **[A] T字路型**: 幹線エッジの25〜75%地点に分岐点を作成、垂直方向に支線を伸ばす
- **[B] 枝分かれ型**: 既存交差点から15度以上異なる方向に支線を伸ばす

### レイヤー3: 一方通行（oneway）

- 支線ペアの約30%を一方通行に変換（逆向きエッジを削除）
- 黄色の▶矢印で方向を表示
- 予算操作で方向反転が可能（-800pt）

### レイヤー4: 外部追加接続

- 各外部ノードの約60%に main / branch / oneway を追加接続
- 外部ノード専用チェック（`canAddExt`）で交差を選択的に許容

### 交差チェック（canAdd / segmentsCross）

全エッジ追加前に以下を検証する。

1. **最小長チェック**: 50px未満は追加しない
2. **重複チェック**: 同一ノードペアに既存エッジがあれば追加しない
3. **厳密交差チェック** (`segmentsCross`, eps=0.03): X字・T字を全て検出
4. **T字接触防止**: 端点が既存エッジの中間点に近い場合（12px以内）は追加しない
5. **近接平行チェック**: cos類似度 > 0.90 かつ中間部距離 < 38px なら追加しない
6. **生成後安全網**: 全エッジペアを走査してクロスが残っていれば除去（最大10パス）

---

## 道路描画（交差点はみ出し修正）

**2パス描画方式**で交差点でのはみ出しを防止する。

**Pass 1 — `drawIntersectionPads()`**

内部 cross ノードの位置に、接続する全エッジの最大道路幅で正方形パッドを先に塗る。  
これで交差点エリアが均一な道路色で埋まる。

**Pass 2 — `drawRoad(e)`**

各エッジを描く際、端が内部 cross ノードの場合はその道路幅分だけ描画開始/終了をトリムする。  
矩形の角が交差点の外に飛び出さない。

---

## マップ生成要素

### 地形テクスチャ

5オクターブのsin合成ノイズでセルごとに地形タイプを決定し、128×128pxタイルを貼る。  
異なるタイル間の境界に32px幅のグラデーションブレンドを重ねて継ぎ目を自然に見せる。

| ノイズ値 | タイル | ファイル |
|---|---|---|
| 0.0〜0.30 | 土 | `ground_3.png` |
| 0.30〜0.55 | 砂地 | `ground_2.png` |
| 0.55〜1.0 | 草地 | `ground_1.png` |

### 川

隣接する平行幹線の間で条件を満たす場合、85%の確率で川を生成する。

- 幹線間隔が 80〜280px
- 帯状領域の内部に交差点ノードが存在しない

水平・垂直の両方向で判定。波紋アニメーション付き。

### 建物・公園・会社

道路脇に自動配置する。全エッジとの距離チェック（道路幅 + 建物半径 + 余白）で道路上への重なりを防止する。

| 種類 | 確率 | 機能 |
|---|---|---|
| 住宅 | 60% | 装飾のみ |
| 会社 | 25% | 目的地になる（20%の確率で車の行き先に選択） |
| 公園 | 15% | 装飾のみ |

### 駐車場

全エッジの道路脇に3〜6箇所配置する。スポーン地点かつ目的地として機能する。

---

## 交通ルール

### 左側通行

```
法線ベクトル: nx = (-vy/len, vx/len)  ← 進行方向の右が正
オフセット:   -(LANE_W/2 + lane × LANE_W)  ← 負方向 = 左側
```

### エッジタイプ

| タイプ | 車線数 | 方向性 |
|---|---|---|
| `main` | 2 | 双方向ペア |
| `branch` | 1 | 双方向ペア |
| `oneway` | 1 | 一方向のみ（反転操作可能） |

### 信号制御

- `phase 0`: 縦方向（上下）青 / `phase 1`: 横方向（左右）青
- 車は `pos > 0.85` かつ赤信号の場合に停車
- 交差点クリックで青時間を個別調整可能（信号あり交差点のみ）

### 車両ルーティング

BFS（幅優先探索）でルートを生成する。

| 目的地 | 確率 |
|---|---|
| 駐車場 | 30% |
| 会社（最寄り交差点経由） | 20% |
| 支線末端 | 20% |
| 外部ノード（通過） | 30% |

---

## データ構造

### Node

| プロパティ | 型 | 説明 |
|---|---|---|
| `x, y` | number | 座標 |
| `type` | string | `"cross"` / `"house"` / `"park"` / `"company"` / `"parking"` |
| `external` | bool | 外部ノード・駐車場フラグ |
| `hasSignal` | bool | 信号機あり/なし（内部 cross のみ有効） |
| `phase` | 0/1 | 信号フェーズ |
| `greenDuration` | number | 青信号継続フレーム数 |

### Edge

| プロパティ | 型 | 説明 |
|---|---|---|
| `from, to` | Node | 接続ノード（一方通行） |
| `type` | string | `"main"` / `"branch"` / `"oneway"` |
| `lanes` | number | 車線数 |
| `length` | number | エッジ長さ（px） |
| `laneCars` | Array[] | 各車線の車リスト |

### Car

| プロパティ | 型 | 説明 |
|---|---|---|
| `route` | Array | `[{edge, lane}, ...]` のルート |
| `pos` | number | 現エッジ上の位置（0.0〜1.0） |
| `speed` | number | 現在速度 |
| `maxSpeed` | number | 最大速度（ランダム） |
| `wait` | number | 停車累積フレーム数 |
| `isPolice` | bool | パトカーフラグ |
| `targetAcc` | object | 担当事故への参照 |

### Accident

| プロパティ | 型 | 説明 |
|---|---|---|
| `x, y` | number | 発生座標 |
| `timer` | number | 残り継続フレーム数 |
| `maxTimer` | number | 最大継続フレーム数（1800） |
| `policeArrived` | bool | パトカー到着済みフラグ |

---

## ファイル構成

```
traffic_simulation_fixed.html   メインファイル（単一HTMLで完結）
README.md                       本ドキュメント
douro.png                       幹線・支線道路テクスチャ
douro_small.png                 一方通行テクスチャ（67×67px）
river.png                       川テクスチャ（128×128px）
parking.png                     駐車場画像
shingou_blue.png                信号機・青（400×150px）
shingou_red.png                 信号機・赤（400×150px）
car_police.png                  パトカー画像
car1.png 〜 car10.png           車両画像（10種）
house1.png 〜 house8.png        住宅画像（8種）
company1.png 〜 company4.png    会社ビル画像（4種）
park1.png                       公園画像
ground_1.png                    地形タイル（草地・128×128px）
ground_2.png                    地形タイル（砂地・128×128px）
ground_3.png                    地形タイル（土・128×128px）
```

---

## 描画レイヤー順

```
① 地形テクスチャ（sin合成ノイズ × タイル画像）
② 川（波紋アニメーション付き）
③-a 交差点パッド（エッジより先に塗り、はみ出しを防ぐ）
③-b 道路エッジ（両端をトリムして描画）
④ 車両（パトカーはサイレン点滅）
⑤ 事故マーカー（💥 + 影響圏 + 残り時間バー + 🚔）
⑥ 一方通行反転ハイライト
⑦ ノード（交差点信号 / ⚠ / 建物 / 駐車場）
```

---

## 既知の制限・今後の課題

- 斜め支線が生成されることがある（設計上許容）
- 信号は縦横2フェーズのみ（左折専用フェーズは未対応）
- 車線変更未実装（ルート確定時に車線を固定）
- ミッション制・VIPカーなどのゲーム性拡張は今後検討
