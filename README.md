都市交通シミュレーション  ルール

このプロジェクトは、主要道路と支線道路からなる自然な都市道路網をブラウザ上で生成・可視化し、車両の挙動や信号の制御をシミュレートするシステムです。本コードを生成・修正する際は、以下のルールを必ず遵守してください。

1. 道路網生成のルール
1.1 主要道路

原則としてグリッドに沿うが、完全にマス目にはしない。

片側2車線×2方向（合計4車線）で生成。

中央分離帯あり。車は上下線で正しい方向に進行。

完全に直線の区間でも交差点を作らず、単なる直線道路として扱う。

主要道路同士の交差は、ランダムに一部スキップして自然さを確保。

主要道路の直線区間は、支線道路との交差判定が正しく働く。

1.2 支線道路

支線道路は直線のみ。

支線は必ず主要道路につながる。

支線同士の近接や重複生成を避ける。

支線道路で逆走は発生しない。

支線の枝分かれはランダムだが、行き止まり（末端が交差点）にならないようにする。

1.3 外部ノード

マップ外周に生成する入り口・出口ノード。

外部ノードから必ず道路を主要道路に接続。

外部ノードはランダムに配置。

2. 車両挙動のルール

車は進行方向に沿って走行（逆走禁止）。

主要道路：各車線は同方向に走行、反対方向の車線と衝突なし。

支線道路：単方向1車線。

車は前方車両との距離を考慮して減速・停止。

信号に従って停止・発進。

進入可能な道路がない場合、車両は消去または次の接続道路に移動。

車のランダム生成は外部ノードや主要道路の出発点で行う。

3. 信号のルール

信号は交差点に設置。

信号は道路がある方向のみ表示（上・下・左・右）。

信号のタイミングは交差点単位で個別管理可能。

信号のフェーズは2相（縦方向と横方向）。

信号の表示は車両の進行方向に合わせる。

4. 描画ルール

主要道路：

片側2車線×2方向（4車線）

中央分離帯を描画

白線で車線を区切る

支線道路：

単方向1車線

白線で区切る

車両は車の画像で描画

信号は方向ごとに描画

道路は複数の画像を横に並べて延長描画

5. 衝突・交差判定

道路同士の交差は、端点を共有しない場合にのみ許可。

交差点の不要な生成を防止。

支線道路と主要道路の接続時に重複や行き止まりを避ける。

6. UI パラメータ

流入量（車の生成確率）

信号青時間（交差点のタイマー）

時間帯（Rush/Day/Night）

渋滞指標（停車中の車両数）

7. コード生成時のチェックリスト

主要道路は上下線2車線ずつで4車線になっているか？

支線道路は直線のみで主要道路に接続されているか？

逆走車は存在しないか？

信号は道路がある方向にのみ表示されているか？

道路の行き止まりや不要な交差点がないか？

車両生成・描画・進行方向は正しいか？

描画時に中央分離帯・車線・車両が正しく表示されているか？

コンソールエラーや構文エラーが発生していないか？

このルールを守ることで、毎回自然で正しい都市道路シミュレーションコードを生成できます。
