# 都市交通シミュレーション

ブラウザ上で動作する2D都市交通シミュレーションゲーム。  
リロードのたびに異なる道路レイアウト・地形・川が自動生成される。  
信号制御・予算管理・事故対応・パトカー派遣などを通じて渋滞を解消し、スコアを伸ばす。

---

## 起動方法

```
traffic_simulation_fixed.html をブラウザで開く
```

以下のファイルを同じディレクトリに配置する。画像が存在しない場合はフォールバック表示で動作する。

### 道路・地形

| ファイル名 | 内容 | サイズ |
|---|---|---|
| `douro.png` | 幹線道路テクスチャ | 横タイル任意 |
| `douro_small.png` | 支線・一方通行道路テクスチャ | 67×67 px |
| `kousaten.png` | 交差点画像（正八角形） | 300×300 px |
| `river.png` | 川テクスチャ | 128×128 px |
| `ground_1.png` | 地形タイル（草地） | 128×128 px |
| `ground_2.png` | 地形タイル（砂地） | 128×128 px |
| `ground_3.png` | 地形タイル（土） | 128×128 px |

### 施設・建物

| ファイル名 | 内容 | サイズ |
|---|---|---|
| `parking.png` | 駐車場 | 60×60 px |
| `house1.png` 〜 `house8.png` | 住宅（8種） | 40×40 px相当 |
| `company1.png` 〜 `company4.png` | 会社ビル（4種） | 50×50 px |
| `park1.png` | 公園 | 40×40 px相当 |

### 信号・サイン

| ファイル名 | 内容 | サイズ |
|---|---|---|
| `shingou_blue.png` | 信号機（青） | 400×150 px |
| `shingou_red.png` | 信号機（赤） | 400×150 px |
| `s_straight.png` | 進行方向サイン：直進 | 15×22 px |
| `s_right.png` | 進行方向サイン：右折 | 15×22 px |
| `s_left.png` | 進行方向サイン：左折 | 15×22 px |
| `s_st_right.png` | 進行方向サイン：直進右折 | 15×22 px |
| `s_st_left.png` | 進行方向サイン：直進左折 | 15×22 px |
| `s_right_left.png` | 進行方向サイン：右左折 | 15×22 px |
| `s_st_right_left.png` | 進行方向サイン：直進右左折 | 14×21 px |

### 車両

| ファイル名 | 内容 |
|---|---|
| `car1.png` 〜 `car10.png` | 車両（10種） |
| `car_police.png` | パトカー |

---

## ゲームの目的

交差点への信号設置・一方通行の反転・事故対応などを通じて渋滞を解消し、スコアを稼ぐ。  
スコアは同時に「予算」として機能し、各種操作のコストに充てる。

---

## UI操作

### スコアバー（画面最上部）

| 表示 | 説明 |
|---|---|
| **SCORE / 予算** | 現在の累計スコア（＝使用可能予算） |
| **RANK** | S / A / B / C / D のランク |
| **BONUS** | 渋滞ゼロ継続で上昇するボーナス倍率（最大×8.0） |
| **事故件数** | 累計発生事故数 |
| **渋滞** | 現在の渋滞台数（wait > 60フレームの車） |

### コントロールパネル（上部）

| 操作 | 説明 |
|---|---|
| **流入量スライダー** | 車の発生頻度（0〜100） |
| **交差点青時間スライダー** | 選択中の信号あり交差点の青時間（60〜300フレーム） |
| **🚨 対応ボタン** | 事故を即時解消（-300pt） |

### サイドパネル（右側）— 予算操作

| ボタン | コスト | 操作方法 |
|---|---|---|
| **信号設置** | -500pt | モード選択後、交差点をクリック |
| **信号撤去** | -300pt | モード選択後、交差点をクリック |
| **一方通行反転** | -800pt | モード選択後、道路を1回クリック（黄色ハイライト）→ もう1回で確定 |
| **事故対応** | -300pt | ボタンクリック、またはCanvas上の💥を直接クリック |
| **✕ キャンセル** | 無料 | 操作モードを解除 |

---

## スコアシステム

### 加算

- 車が目的地に到着: **+200点 × ボーナス倍率**
- 渋滞ゼロが60フレーム（約1秒）続くごとにボーナス倍率 **+0.2**（上限×8.0）

### ペナルティ

| イベント | ペナルティ |
|---|---|
| 事故発生 | -500点 |
| 事故継続中（1件/フレーム） | -1点 |
| 渋滞中（1台/フレーム） | -0.2点 |
| 渋滞発生時のボーナス倍率低下 | -0.02/フレーム（最低1.0） |
| 信号設置 | -500点 |
| 信号撤去 | -300点 |
| 一方通行反転 | -800点 |
| 事故対応（緊急解消） | -300点 |

### ランク基準

| ランク | 必要スコア | 表示色 |
|---|---|---|
| **S** | 80,000点以上 | ピンク |
| **A** | 35,000点以上 | オレンジ |
| **B** | 12,000点以上 | 黄緑 |
| **C** | 3,000点以上 | 水色 |
| **D** | 3,000点未満 | グレー |

---

## 信号システム

### 初期配置

ゲーム開始時に内部交差点の約40%のみ信号が設置される。残り60%は信号なし状態。

### 信号あり交差点

2フェーズ制御（縦方向青 / 横方向青）で交互に切り替わる。  
`pos > 0.85` の位置で赤信号を検知した車は停車する。  
交差点クリックで青時間を個別調整可能（60〜300フレーム）。

### 信号なし交差点

| 状態 | 挙動 |
|---|---|
| 交差点まで残り35%（pos > 0.65） | 最大速度の15%に徐行制限 |
| 同じ交差点へ向かう他方向の車がいる | posが大きい（先着）車に完全停止して譲る |
| 表示 | 交差点に⚠マーク |

---

## 進行方向サイン

各交差点に向かうエッジの手前（交差点パッド境界の手前）に、その先で進める方向を示すサイン画像を路面に描画する。

### 表示ロジック

入ってくるエッジ方向と出ていくエッジ方向の角度変化（外積・内積）で進行方向を判定する。

| 角度変化 | 判定 |
|---|---|
| ±30度以内 | 直進 |
| 正方向（左回り） | 左折 |
| 負方向（右回り） | 右折 |

### サイン種別

| 使用画像 | 表示条件 |
|---|---|
| `s_straight.png` | 直進のみ |
| `s_right.png` | 右折のみ |
| `s_left.png` | 左折のみ |
| `s_st_right.png` | 直進＋右折 |
| `s_st_left.png` | 直進＋左折 |
| `s_right_left.png` | 右折＋左折 |
| `s_st_right_left.png` | 直進＋右折＋左折（全方向） |

### 描画方法

配置点（交差点直前の各車線中央）をワールド座標で計算した上で、  
`signRotation = roadAngle + π/2` の角度で回転させて描画する。  
これにより縦・横・斜めすべての道路方向で矢印が正しく向く。

---

## 車両システム

### 車線ルール（左側通行）

```
法線ベクトル: nx = (-vy/len, vx/len)  ← 進行方向の右が正
オフセット:   -(LANE_W/2 + lane × LANE_W)  ← 負方向 = 左側
lane0: 中央寄り（内側）
lane1: 外側
```

### 交差点での車線選択

BFSでルートを生成する際、交差点を通過するたびに進行方向の変化角で初期車線を決定する。

| 進行方向 | 車線 | 理由 |
|---|---|---|
| 直進 / 右折 | lane0（内側・中央寄り） | 右折は内側から |
| 左折（>30度） | lane1（外側） | 左折は外側から |

### 車線変更

`main`（2車線）走行中に以下の条件を全て満たすと隣車線へ変更する。

| 条件 | 値 |
|---|---|
| 前方の詰まり | gap < SLOW_GAP × 1.8（108px） |
| 隣車線前方の余裕 | 現在より30%以上広い |
| 隣車線後方の余裕 | MIN_GAP × 1.5（30px）以上 |
| 変更可能区間 | pos 0.15〜0.80（端付近は禁止） |
| クールダウン | 変更後90フレーム（約1.5秒）は不可 |

### 速度制御定数

| 定数 | 値 | 説明 |
|---|---|---|
| `LANE_W` | 18 px | 1車線の幅 |
| `MIN_GAP` | 20 px | 前車との最小距離 |
| `SLOW_GAP` | 60 px | 減速開始距離 |
| `maxSpeed` | 1.0〜2.2 | 車両ごとのランダム最高速度 |

---

## 事故イベント

60〜120秒に1回、ランダムに交通事故が発生する。

### 発生時の挙動

- 走行中の車がいるエッジ上のランダムな地点で発生
- 💥アイコンと赤い影響圏（半径80px）を表示
- 影響圏内の車は強制徐行（速度0.2以下）→ 渋滞が伝播
- 残り時間バーが表示され、終盤ほど点滅が速くなる
- 約30秒後（1800フレーム）に自動復旧
- 発生時に -500点ペナルティ、継続中は毎フレーム -1点

### パトカー派遣

- 事故発生と同時に外部ノードからBFSで最寄り交差点へ自動派遣
- 最高速度2.5（通常車の約1.5倍）で走行
- 走行中はサイレン（赤/青交互点滅）を表示
- 現場到着後は事故解消まで待機（💥横に🚔表示）
- 事故解消とともに消滅

### 手動対応

- 🚨ボタンまたは💥アイコンを直接クリックで即時解消（-300点）

---

## 道路生成ロジック

### レイヤー1: 幹線（main）

- 水平線 2〜3本 + 垂直線 2〜3本をランダムなy/x座標に配置
- 交点を自動計算して交差点ノードを生成
- 2車線（片側2レーン）、双方向エッジペア

**外部ノード生成パターン（リロードごとにランダム選択）**

| パターン | 確率 | 内容 |
|---|---|---|
| A | 40% | 全幹線端に外部ノード |
| B | 35% | 各端を約55%の確率で間引き |
| C | 25% | 各端を約25%のみ生成（内側都市型） |

### レイヤー2: 支線（branch）

- **[A] T字路型**: 幹線エッジの25〜75%地点に分岐点を作成、垂直方向に支線を伸ばす
- **[B] 枝分かれ型**: 既存交差点から15度以上異なる方向に支線を伸ばす

### レイヤー3: 一方通行（oneway）

- 支線ペアの約30%を一方通行に変換（逆向きエッジを削除）
- 黄色の▶矢印で方向を表示
- 予算操作で方向反転が可能（-800pt）

### レイヤー4: 外部追加接続

- 各外部ノードの約60%に main / branch / oneway を追加接続
- 外部ノード専用チェック（`canAddExt`）で交差を選択的に許容

### 交差チェック（canAdd / segmentsCross）

全エッジ追加前に以下を検証する。

1. **最小長チェック**: 50px未満は追加しない
2. **重複チェック**: 同一ノードペアに既存エッジがあれば追加しない
3. **厳密交差チェック** (`segmentsCross`, eps=0.03): X字・T字を全て検出
4. **T字接触防止**: 端点が既存エッジの中間点に近い場合（12px以内）は追加しない
5. **近接平行チェック**: cos類似度 > 0.90 かつ中間部距離 < 38px なら追加しない
6. **生成後安全網**: 全エッジペアを走査してクロスが残っていれば除去（最大10パス）

---

## 道路描画システム

### 描画レイヤー順

```
① 地形テクスチャ（sinノイズ × タイル画像）
② 川（波紋アニメーション付き）
③-a branch / oneway（支線・一方通行）← 最背面
③-b main（幹線）                     ← 中間（支線の上）
③-c 交差点パッド kousaten.png         ← 最前面（全道路を覆う）
③-d 進行方向サイン                   ← 路面の最上位
④  車両（パトカーはサイレン点滅）
⑤  事故マーカー（💥 + 影響圏 + 残り時間バー + 🚔）
⑥  一方通行反転ハイライト
⑦  ノード（交差点信号 / ⚠ / 建物 / 駐車場）
```

幹線が支線の上に描画され、交差点パッドが全道路を覆うことで自然な立体感が生まれる。

### 交差点パッド描画（`drawIntersectionPads`）

各内部 cross ノードに `kousaten.png` を描画する。  
サイズは接続エッジの最大道路幅で自動スケーリング（maxW × 2 の正方形）。

### エッジのトリム処理（`drawRoad`）

各エッジを描く際、端が内部 cross ノードの場合は交差点パッドの半径分だけ描画をトリムする。  
トリム量 = 対象ノードに接続する全エッジの最大道路幅

### テクスチャ種別

| エッジタイプ | テクスチャ | 備考 |
|---|---|---|
| `main` | `douro.png` | 2車線幅、車線白線あり |
| `branch` | `douro_small.png` | 1車線幅、上下2エッジで自然な双方向 |
| `oneway` | `douro_small.png` | 1車線幅、▶矢印付き |
| 交差点 | `kousaten.png` | ノードサイズに合わせてスケーリング |

---

## マップ生成要素

### 地形テクスチャ

5オクターブのsin合成ノイズでセルごとに地形タイプを決定し、128×128pxタイルを貼る。  
異なるタイル間の境界に32px幅のグラデーションブレンドを重ねて継ぎ目を自然に見せる。

| ノイズ値 | タイル |
|---|---|
| 0.0〜0.30 | 土（`ground_3.png`） |
| 0.30〜0.55 | 砂地（`ground_2.png`） |
| 0.55〜1.0 | 草地（`ground_1.png`） |

### 川

隣接する平行幹線の間で条件を満たす場合、85%の確率で川を生成する。

- 幹線間隔が 80〜280px
- 帯状領域の内部に交差点ノードが存在しない

水平・垂直の両方向で判定。波紋アニメーション付き。

### 建物・公園・会社

道路脇に自動配置する。全エッジとの距離チェック（道路幅 + 建物半径 + 余白）で道路上への重なりを防止する。

| 種類 | 確率 | 機能 |
|---|---|---|
| 住宅 | 60% | 装飾のみ |
| 会社 | 25% | 目的地になる（20%の確率で車の行き先に選択） |
| 公園 | 15% | 装飾のみ |

### 駐車場

全エッジの道路脇に3〜6箇所配置する。スポーン地点かつ目的地として機能する。

---

## 車両ルーティング

BFS（幅優先探索）でルートを生成する。

| 目的地 | 確率 |
|---|---|
| 駐車場 | 30% |
| 会社（最寄り交差点経由） | 20% |
| 支線末端 | 20% |
| 外部ノード（通過） | 30% |

---

## データ構造

### Node

| プロパティ | 型 | 説明 |
|---|---|---|
| `x, y` | number | 座標 |
| `type` | string | `"cross"` / `"house"` / `"park"` / `"company"` / `"parking"` |
| `external` | bool | 外部ノード・駐車場フラグ |
| `hasSignal` | bool | 信号機あり/なし（内部 cross のみ有効） |
| `phase` | 0/1 | 信号フェーズ（0=縦青, 1=横青） |
| `greenDuration` | number | 青信号継続フレーム数（60〜300） |

### Edge

| プロパティ | 型 | 説明 |
|---|---|---|
| `from, to` | Node | 接続ノード（from→to の一方通行） |
| `type` | string | `"main"` / `"branch"` / `"oneway"` |
| `lanes` | number | 車線数（main=2, branch/oneway=1） |
| `length` | number | エッジ長さ（px） |
| `laneCars` | Array[] | 各車線の車リスト |

### Car

| プロパティ | 型 | 説明 |
|---|---|---|
| `route` | Array | `[{edge, lane}, ...]` のルート |
| `pos` | number | 現エッジ上の位置（0.0〜1.0） |
| `speed` | number | 現在速度 |
| `maxSpeed` | number | 最大速度（1.0〜2.2ランダム） |
| `wait` | number | 停車累積フレーム数 |
| `laneChangeCooldown` | number | 車線変更クールダウン残フレーム |
| `isPolice` | bool | パトカーフラグ（maxSpeed=2.5） |
| `targetAcc` | object | 担当事故への参照 |

### Accident

| プロパティ | 型 | 説明 |
|---|---|---|
| `x, y` | number | 発生座標 |
| `edge` | Edge | 発生エッジ |
| `timer` | number | 残り継続フレーム数 |
| `maxTimer` | number | 最大継続フレーム数（1800） |
| `blink` | number | 点滅カウンタ |
| `policeArrived` | bool | パトカー到着済みフラグ |

---

## ファイル構成

```
traffic_simulation_fixed.html   メインファイル（単一HTMLで完結）
README.md                       本ドキュメント

# 道路
douro.png                       幹線道路テクスチャ
douro_small.png                 支線・一方通行テクスチャ（67×67px）
kousaten.png                    交差点画像（300×300px）

# 地形・自然
river.png                       川テクスチャ（128×128px）
ground_1.png                    地形タイル 草地（128×128px）
ground_2.png                    地形タイル 砂地（128×128px）
ground_3.png                    地形タイル 土（128×128px）

# 施設
parking.png                     駐車場（60×60px）
house1.png 〜 house8.png        住宅（8種）
company1.png 〜 company4.png    会社ビル（4種）
park1.png                       公園

# 信号機
shingou_blue.png                信号機 青（400×150px）
shingou_red.png                 信号機 赤（400×150px）

# 進行方向サイン（交差点手前の路面に描画）
s_straight.png                  直進（15×22px）
s_right.png                     右折（15×22px）
s_left.png                      左折（15×22px）
s_st_right.png                  直進右折（15×22px）
s_st_left.png                   直進左折（15×22px）
s_right_left.png                右左折（15×22px）
s_st_right_left.png             直進右左折（14×21px）

# 車両
car1.png 〜 car10.png           車両（10種）
car_police.png                  パトカー
```

---

## 既知の制限・今後の課題

- 信号は縦横2フェーズのみ（左折専用フェーズは未対応）
- 車線変更は main（2車線）のみ対応
- ミッション制・VIPカー・道路封鎖などのゲーム性拡張は今後検討
