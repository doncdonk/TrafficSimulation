# 都市交通シミュレーション

ブラウザ上で動作する2D都市交通シミュレーションゲーム。  
リロードのたびに異なる道路レイアウトが自動生成され、車両がリアルタイムで走行する。

---

## 起動方法

```
traffic_simulation_fixed.html をブラウザで開く
```

以下の画像ファイルを同じディレクトリに配置すること。

| ファイル名 | 内容 |
|---|---|
| `douro.png` | 道路テクスチャ |
| `car1.png` 〜 `car10.png` | 車両画像（10種） |
| `house1.png` 〜 `house8.png` | 住宅画像（8種） |
| `park1.png` | 公園画像 |

画像が存在しない場合はフォールバック表示（黄色矩形など）で動作する。

---

## UI操作

| 操作 | 説明 |
|---|---|
| **流入量スライダー** | 車の発生頻度を調整（0〜100） |
| **交差点青時間スライダー** | 選択中の交差点の信号青時間を調整（60〜300フレーム） |
| **交差点クリック** | 交差点を選択し、信号タイミングを個別に設定可能 |
| **渋滞カウンター** | 60フレーム以上待機している車の数をリアルタイム表示 |
| **時間帯表示** | Day / Rush / Night の3段階で変化し、流入量に影響 |

---

## 道路生成ロジック

リロードのたびにランダムな都市道路が生成される。階層モデルを採用。

### レイヤー1: 幹線（arterial）
- 水平線 2〜3本 + 垂直線 2〜3本をランダムなy/x座標に配置
- 水平線と垂直線の交点を自動計算し交差点ノードを生成
- 各幹線の端点はマップ外周の外部ノード（進入・退出口）になる
- 2車線（片側2レーン）

### レイヤー2: 支線（branch）— 2種類

**[A] 道路途中T字路型**
- 幹線エッジの25〜75%地点に分岐点ノードを作成
- 元エッジを2分割し、分岐点から垂直方向に支線を伸ばす
- 末端が近隣交差点と接続できれば通り抜け可能な支線になる

**[B] 交差点枝分かれ型**
- 既存交差点から既存道路と15度以上異なる方向に支線を伸ばす
- 近くに既存交差点がある場合はスナップして通り抜け支線に
- 1車線（片側1レーン）

### 重複・交差防止チェック（canAdd）
全てのエッジ追加前に以下を検証し、失敗時はそのエッジを生成しない。

1. **最小長チェック**: 50px未満のエッジは生成しない
2. **重複チェック**: 同一ノードペア間にエッジが既にある場合は追加しない
3. **交差チェック**: 既存エッジと交差する場合は追加しない（端点共有は除外）
4. **近接平行チェック**: ほぼ平行（cos類似度 > 0.90）かつ線分中間部の距離が38px未満の場合は重複とみなして追加しない（端点=交差点は除外して誤判定を防ぐ）

---

## 交通ルール

### 左側通行
全車両は進行方向の左側レーンを走行する。

```
Canvas座標系（Y軸下向き）における法線ベクトル:
  nx = (-vy/len, vx/len) → 進行方向の右側が正

左側通行のオフセット:
  offset = -(LANE_W/2 + lane × LANE_W)   [負方向 = 進行左側]
  lane0: 中央寄り、lane1: 外側
```

### エッジの方向性
全エッジは `from → to` の一方通行として定義。  
双方向通行は `A→B` と `B→A` の2本のエッジペアで実現。

```
幹線:  Edge(A→B, "main", 2車線) + Edge(B→A, "main", 2車線)
支線:  Edge(A→B, "branch", 1車線) + Edge(B→A, "branch", 1車線)
外部:  Edge(ext→内部, "branch") + Edge(内部→ext, "branch")
```

### 信号制御
- 各内部交差点が独立した信号タイマーを持つ
- `phase 0`: 縦方向（上下）青、横方向赤
- `phase 1`: 横方向（左右）青、縦方向赤
- 車は次のノードが赤信号かつ `pos > 0.85` の場合に停車

### 車両挙動
- 前方車両との車間距離で速度を調整（追従モデル）
  - `gap < 20px`: 停車
  - `gap < 60px`: 比例減速
- 外部ノードからスポーン、別の外部ノードへ到達で消滅
- BFS（幅優先探索）でルートを生成

### 時間帯
| 時間帯 | フレーム範囲 | 流入倍率 |
|---|---|---|
| Rush | 0〜800, 1800〜2600 | 高（×0.08） |
| Day | 800〜1800, 2600〜3000 | 中（×0.02） |
| Night | 3000〜3600 | 低（×0.01） |

---

## データ構造

### Node
| プロパティ | 説明 |
|---|---|
| `x, y` | 座標 |
| `type` | `"cross"` / `"house"` / `"park"` |
| `external` | 外部ノード（マップ外周）フラグ |
| `phase` | 信号フェーズ（0 or 1） |
| `timer` | 信号タイマー |
| `greenDuration` | 青信号の継続フレーム数 |

### Edge
| プロパティ | 説明 |
|---|---|
| `from, to` | 接続ノード（一方通行） |
| `type` | `"main"` / `"branch"` |
| `lanes` | 車線数（main=2, branch=1） |
| `length` | エッジ長さ（px） |
| `laneCars` | 各車線の車リスト |

### Car
| プロパティ | 説明 |
|---|---|
| `route` | `[{edge, lane}, ...]` のルート配列 |
| `pos` | 現エッジ上の位置（0.0〜1.0） |
| `speed` | 現在速度 |
| `maxSpeed` | 最大速度（1.0〜2.2、ランダム） |
| `wait` | 停車累積フレーム数（渋滞判定に使用） |

---

## ファイル構成

```
traffic_simulation_fixed.html   メインファイル（単一HTMLで完結）
README.md                       本ドキュメント
douro.png                       道路テクスチャ
car1.png 〜 car10.png           車両画像
house1.png 〜 house8.png        住宅画像
park1.png                       公園画像
```

---

## 既知の制限・今後の課題

- 支線が斜め方向に生成されることがある（canAddの交差チェック通過時）
- 交差点描画は矩形のみ（曲線・ランナバウト未対応）
- 車線変更ロジック未実装（ルート確定時に車線を固定）
- 信号は縦横2フェーズのみ（左折専用フェーズ等は未対応）
